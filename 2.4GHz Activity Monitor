#include <SPI.h>
#include <RF24.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64

// OLED I2C pins for ESP-C3-32S-Kit
#define OLED_SDA 8  // GPIO8 (D8)
#define OLED_SCL 9  // GPIO9 (D9)

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// nRF24L01 pins for ESP-C3-32S-Kit (correct pins!)
#define CE_PIN    4  // GPIO4 (D4)
#define CSN_PIN   5  // GPIO5 (D5)
#define SCK_PIN   6  // GPIO6 (D6/SCK)
#define MOSI_PIN  7  // GPIO7 (D7/MOSI)
#define MISO_PIN  2  // GPIO2 (D2/MISO) - This was the key!

RF24 radio(CE_PIN, CSN_PIN);

// For better visualization
#define NUM_CHANNELS 126
uint8_t channelActivity[NUM_CHANNELS];
uint8_t channelPeak[NUM_CHANNELS];  // For peak hold display

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("\n=== ESP-C3-32S-Kit RF Radar Starting ===");
  
  // Initialize I2C for OLED
  Wire.begin(OLED_SDA, OLED_SCL);
  
  // Initialize OLED
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("OLED initialization failed - check address");
    // Try alternative address
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3D)) {
      Serial.println("OLED failed on both addresses");
    }
  }
  
  // Splash screen
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(25, 20);
  display.println("RF RADAR");
  display.setCursor(15, 35);
  display.println("ESP-C3-32S-Kit");
  display.display();
  delay(1500);
  
  // Initialize SPI with correct pins
  Serial.println("Initializing SPI...");
  SPI.begin(SCK_PIN, MISO_PIN, MOSI_PIN, CSN_PIN);
  
  // Configure pins
  pinMode(CE_PIN, OUTPUT);
  pinMode(CSN_PIN, OUTPUT);
  digitalWrite(CE_PIN, LOW);
  digitalWrite(CSN_PIN, HIGH);
  
  delay(100);
  
  // Initialize nRF24
  Serial.println("Initializing nRF24...");
  
  if (!radio.begin()) {
    Serial.println("nRF24 initialization failed!");
    display.clearDisplay();
    display.setCursor(0, 0);
    display.println("nRF24 ERROR!");
    display.println("Check wiring");
    display.display();
    while(1);
  }
  
  Serial.println("nRF24 detected successfully!");
  
  // Configure for radar mode
  radio.setAutoAck(false);
  radio.stopListening();
  radio.setRetries(0, 0);
  radio.setPALevel(RF24_PA_MIN);  // Use MIN power for now
  radio.setDataRate(RF24_1MBPS);
  radio.setCRCLength(RF24_CRC_DISABLED);
  
  // Clear peak array
  memset(channelPeak, 0, sizeof(channelPeak));
  
  Serial.println("RF Radar ready!");
  display.clearDisplay();
  display.setCursor(25, 20);
  display.println("READY!");
  display.setCursor(10, 35);
  display.println("Scanning 2.4GHz");
  display.display();
  delay(1000);
}

void loop() {
  // Clear current activity
  memset(channelActivity, 0, sizeof(channelActivity));
  
  // Sweep through all channels
  for (int ch = 0; ch < NUM_CHANNELS; ch++) {
    radio.setChannel(ch);
    radio.startListening();
    
    // Wait for valid measurement
    delayMicroseconds(150);
    
    // Check for signal
    if (radio.testRPD()) {
      channelActivity[ch] = 1;
      
      // Update peak if this is higher
      if (channelPeak[ch] < 10) {
        channelPeak[ch] = 10;  // Set peak to max height
      }
    }
    
    radio.stopListening();
    
    // Decay peaks slowly
    if (channelPeak[ch] > 0) {
      channelPeak[ch]--;
    }
  }
  
  // Display the spectrum
  display.clearDisplay();
  
  // Draw title
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.print("2.4GHz RF Radar");
  
  // Draw channel numbers
  display.setTextSize(1);
  display.setCursor(0, 55);
  display.print("0");
  display.setCursor(115, 55);
  display.print("125");
  
  // Draw baseline
  display.drawLine(0, 52, 127, 52, SSD1306_WHITE);
  
  // Draw current activity (green/white lines)
  for (int i = 0; i < NUM_CHANNELS; i++) {
    if (channelActivity[i]) {
      int x = map(i, 0, NUM_CHANNELS-1, 0, 127);
      // Draw signal line
      display.drawLine(x, 52, x, 30, SSD1306_WHITE);
    }
  }
  
  // Draw peak hold (dotted lines)
  for (int i = 0; i < NUM_CHANNELS; i+=2) {  // Every other channel to save CPU
    if (channelPeak[i] > 0) {
      int x = map(i, 0, NUM_CHANNELS-1, 0, 127);
      int peakY = 52 - channelPeak[i];
      if (peakY < 20) peakY = 20;
      display.drawPixel(x, peakY, SSD1306_WHITE);
    }
  }
  
  // Draw WiFi channel markers (1, 6, 11)
  display.drawLine(20, 53, 20, 55, SSD1306_WHITE);  // Ch 1
  display.drawLine(61, 53, 61, 55, SSD1306_WHITE);  // Ch 6
  display.drawLine(102, 53, 102, 55, SSD1306_WHITE); // Ch 11
  
  display.display();
  
  // Small delay between sweeps
  delay(50);
}
